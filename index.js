import { Telegraf } from "telegraf";
import express from "express";
import { CronJob } from "cron";
import dotenv from "dotenv";
import mongoose from "mongoose";

import { messages } from "./messages.js";
import { excuses } from "./excuses.js";
import { images } from "./images.js";
import { stopMsgs } from "./stop.js";

import { User } from "./models/User.js";
import { CronTask } from "./models/CronTask.js";

dotenv.config();

async function restoreCronJobs() {
    const activeTasks = await CronTask.find({});
    activeTasks.forEach((task) => {
        startCronJob(task.chatId);
    });
}


async function updateCronJobs() {
    const activeTasks = await CronTask.find({});
    activeTasks.forEach(async (task) => {

        if (task) {

            if (task.job) {
                task.job.stop();
            }

            const newJob = new CronJob(
                "53 5 * * *",
                async function () {

                    const currentMessage = "üåû –î–æ–±—Ä–æ–µ –∏ —á—É–¥–µ—Å–Ω–æ–µ —É—Ç—Ä–µ—á–∫–æ! –í—Å—Ç–∞–≤–∞–π, –ø—Ä–∏–Ω—Ü–µ—Å—Å–∞üë∏, —Å–µ–≥–æ–¥–Ω—è —Ç–≤–æ–π –¥–µ–Ω—å, –¥–µ–Ω—å —Å–∞–º–æ–π –ø—Ä–µ–∫—Ä–∞—Å–Ω–æ–π –±–∞–±–∞—á–µ–Ω–∫–∏ –Ω–∞ –∑–µ–º–ª–µ! –° –ø—Ä–∞–∑–¥–Ω–∏—á–∫–æ–º —Ç–µ–±—è! –ü–æ–ª—å–∑—É—è—Å—å —Å–ª—É—á–∞–µ–º —Ç–æ—Ä–∂–µ—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –¥–Ω—è, —è —Ö–æ—Ç–µ–ª –±—ã —Ä–∞—Å—Å–∫–∞–∑–∞—Ç—å —Ç–µ–±–µ –∏—Å—Ç–æ—Ä–∏—é –æ —Ç–æ–º, —á—Ç–æ —Å–ø–æ–¥–≤–∏–≥–ª–æ –º–µ–Ω—è –Ω–∞–π—Ç–∏ —Ç–µ–±—è‚Ä¶ üå≥‚ú® –û–¥–Ω–∞–∂–¥—ã, –≤ –æ–¥–Ω–æ–º —á—É–¥–µ—Å–Ω–æ–º –ª–µ—Å—É, –≥–¥–µ –¥–µ—Ä–µ–≤—å—è —à–µ–ø—á—É—Ç —Å–∫–∞–∑–∫–∏, –∞ —Ä–µ–∫–∏ –ø–æ—é—Ç –∫–æ–ª—ã–±–µ–ª—å–Ω—ã–µ, –∂–∏–ª–∞ –±–æ–ª—å—à–∞—è –∏ –¥—Ä—É–∂–Ω–∞—è —Å–µ–º—å—è –±–∞–±–∞–∫–æ–≤ ‚Äî –ë–∞–±–∞–∫–µ–≤–∏—á–∏. –ò—Ö –Ω–æ—Ä–∫–∞ –±—ã–ª–∞ —Å–∞–º–æ–π —É—é—Ç–Ω–æ–π –≤–æ –≤—Å–µ–º –ª–µ—Å—É: üè° —Å—Ç–µ–Ω—ã —É–∫—Ä–∞—à–µ–Ω—ã –º—Ö–æ–º, –Ω–∞ –ø–æ–ª–∫–∞—Ö —Å—Ç–æ—è–ª–∏ –±–∞–Ω–æ—á–∫–∏ —Å –º–µ–¥–æ–º üçØ –∏ —è–≥–æ–¥–∞–º–∏ üçì, –∞ —É –æ—á–∞–≥–∞ –≤—Å–µ–≥–¥–∞ –ø–æ—Ç—Ä–µ—Å–∫–∏–≤–∞–ª–∏ –¥—Ä–æ–≤–∞, –Ω–∞–ø–æ–ª–Ω—è—è –¥–æ–º —Ç–µ–ø–ª—ã–º —Å–≤–µ—Ç–æ–º. üêø –£ –ë–∞–±–∞–∫–µ–≤–∏—á–µ–π –¥–æ–ª–≥–æ –Ω–µ –±—ã–ª–æ –¥–µ—Ç–µ–π. –ù–æ –¥—Ä–µ–≤–Ω—è—è –ª–µ–≥–µ–Ω–¥–∞, —Ö—Ä–∞–Ω—è—â–∞—è—Å—è –≤ —Å—Ç–∞—Ä–æ–º –¥—É–ø–ª–µ –î—Ä–µ–≤–∞ –ú—É–¥—Ä–æ—Å—Ç–∏ üåøüìú, –≥–ª–∞—Å–∏–ª–∞: –æ–¥–Ω–∞–∂–¥—ã –≤ —Å–µ–º—å–µ –±–∞–±–∞–∫–æ–≤ —Ä–æ–¥–∏—Ç—Å—è –¥–µ–≤–æ—á–∫–∞ —Å –≥–ª–∞–∑–∞–º–∏ —Ü–≤–µ—Ç–∞ –ª–µ—Å–Ω–æ–π –∑–µ–ª–µ–Ω–∏ üçÄ ‚Äî –∏ —ç—Ç–æ –±—É–¥–µ—Ç –Ω–∞—Å—Ç–æ—è—â–µ–µ —á—É–¥–æ. –û–Ω–∞ –ø—Ä–∏–Ω–µ—Å–µ—Ç –≤ –º–∏—Ä —Å–≤–µ—Ç, –¥–æ–±—Ä–æ –∏ –≥–∞—Ä–º–æ–Ω–∏—é üíñ, –∞ –µ—ë —Å–µ—Ä–¥—Ü–µ –±—É–¥–µ—Ç —Å—Ç–æ–ª—å —á–∏—Å—Ç—ã–º, —á—Ç–æ —Å–∞–º–æ —Å–æ–ª–Ω—Ü–µ ‚òÄÔ∏è –∑–∞—Ö–æ—á–µ—Ç —Å–æ–≥—Ä–µ–≤–∞—Ç—å –µ—ë –ø—É—Ç—å. üåº –ò –≤–æ—Ç –≤ –æ–¥–∏–Ω –≤–µ—Å–µ–Ω–Ω–∏–π –¥–µ–Ω–µ–∫ –≤ —Å–µ–º—å–µ –ë–∞–±–∞–∫–µ–≤–∏—á–µ–π —Å–ª—É—á–∏–ª–æ—Å—å –≤–µ–ª–∏–∫–æ–µ —Å–æ–±—ã—Ç–∏–µ ‚Äî —Ä–æ–¥–∏–ª–∞—Å—å –º–∞–ª–µ–Ω—å–∫–∞—è –±–∞–±–∞—á–µ–Ω–∫–∞, –∫–æ—Ç–æ—Ä—É—é –Ω–∞–∑–≤–∞–ª–∏ –ë–∞–±–∞—á–µ–Ω—É—à–∫–æ–π. –í—Å–µ –ª–µ—Å–Ω—ã–µ –∑–≤–µ—Ä–∏ –ø—Ä–∏—à–ª–∏ –ø–æ–∑–¥—Ä–∞–≤–∏—Ç—å —Ä–æ–¥–∏—Ç–µ–ª–µ–π ü¶äü¶âüê∞, –∏ –¥–∞–∂–µ —Å–∞–º–∞ –õ–µ—Å–Ω–∞—è –§–µ—è –ø–æ—Å–ª–∞–ª–∞ –ª—É—á–∏–∫ —Å–æ–ª–Ω—Ü–∞, —á—Ç–æ–±—ã —Å–æ–≥—Ä–µ—Ç—å –∫—Ä–æ—à–µ—á–Ω—É—é –ª–∞–ø–∫—É –Ω–æ–≤–æ—Ä–æ–∂–¥–µ–Ω–Ω–æ–π. üçÉ –ö–æ–≥–¥–∞ –ë–∞–±–∞—á–µ–Ω—É—à–∫–∞ —Ä–æ–¥–∏–ª–∞—Å—å –∏ –æ—Ç–∫—Ä—ã–ª–∞ —Å–≤–æ–∏ —è—Ä–∫–∏–µ, –∏–∑—É–º—Ä—É–¥–Ω—ã–µ –≥–ª–∞–∑–∫–∏, —Å—Ç–∞–ª–æ —è—Å–Ω–æ ‚Äî –ø—Ä–æ—Ä–æ—á–µ—Å—Ç–≤–æ —Å–±—ã–ª–æ—Å—å. –ß—Ç–æ–±—ã —É–∫—Ä–µ–ø–∏—Ç—å –≤ –Ω–µ–π –≤—Å–µ –∑–∞–ª–æ–∂–µ–Ω–Ω—ã–µ –ø—Ä–∏—Ä–æ–¥–æ–π –¥–∞—Ä—ã, –µ—ë –Ω—É–∂–Ω–æ –±—ã–ª–æ –∏—Å–∫—É–ø–∞—Ç—å –≤ –≤–æ–ª—à–µ–±–Ω–æ–π –≤–∞–Ω–Ω–æ—á–∫–µ. üõÅ –û—Ç–µ—Ü —Å–µ–º–µ–π—Å—Ç–≤–∞, –ë–∞–±–∞–∫ –õ–µ—Å–æ–≤–∏—á, –ø—Ä–∏–≥–æ—Ç–æ–≤–∏–ª –¥—É–±–æ–≤—É—é –∫—É–ø–µ–ª—å üå≥ –∏ –Ω–∞–ø–æ–ª–Ω–∏–ª –µ—ë –ø—Ä–æ–∑—Ä–∞—á–Ω–æ–π –≤–æ–¥–æ–π –∏–∑ —Ä—É—á—å—è. –õ–µ—Å–Ω–∞—è –§–µ—è –¥–æ–±–∞–≤–∏–ª–∞ –≤ –≤–æ–¥—É –æ—Å–æ–±—ã–µ –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç—ã: üåø –î–æ–±—Ä–æ—Ç—É, —á—Ç–æ–±—ã –ë–∞–±–∞—á–µ–Ω—É—à–∫–∞ –≤—Å–µ–≥–¥–∞ –ø–æ–º–æ–≥–∞–ª–∞ –¥—Ä—É–≥–∏–º. üåü –ö—Ä–∞—Å–æ—Ç—É, —á—Ç–æ–±—ã, –≥–ª—è–¥—è –Ω–∞ –Ω–µ—ë, –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ –±—ã–ª–æ –æ—Ç–≤–µ—Å—Ç–∏ –≥–ª–∞–∑. ü¶â –ú—É–¥—Ä–æ—Å—Ç—å, —á—Ç–æ–±—ã –æ–Ω–∞ –Ω–∞—Ö–æ–¥–∏–ª–∞ –≤–µ—Ä–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è. üçì –ò–∑—ã—Å–∫–∞–Ω–Ω–æ—Å—Ç—å, —á—Ç–æ–±—ã –µ—ë —Ä–µ—á—å –∏ –ø–æ—Å—Ç—É–ø–∫–∏ –±—ã–ª–∏ –º—è–≥–∫–∏–º–∏, –∫–∞–∫ –ª–µ–ø–µ—Å—Ç–∫–∏ —Ü–≤–µ—Ç–æ–≤. üé∂ –í–µ—Å–µ–ª–æ—Å—Ç—å, —á—Ç–æ–±—ã –µ—ë —Å–º–µ—Ö –∑–≤–µ–Ω–µ–ª, —Å–ª–æ–≤–Ω–æ –∫–∞–ø–µ–ª—å –≤–µ—Å–Ω–æ–π. üå≤ –°—Ç–æ–π–∫–æ—Å—Ç—å, —á—Ç–æ–±—ã –Ω–∏–∫–∞–∫–∏–µ –±—É—Ä–∏ –Ω–µ —Å–ª–æ–º–∏–ª–∏ –µ—ë –¥—É—Ö. ü´ñ –£—é—Ç, —á—Ç–æ–±—ã —Ä—è–¥–æ–º —Å –Ω–µ–π –≤—Å–µ–º –±—ã–ª–æ —Ç–µ–ø–ª–æ –∏ —Å–ø–æ–∫–æ–π–Ω–æ. üíñ –õ—é–±–æ–≤—å, —á—Ç–æ–±—ã –µ—ë —Å–µ—Ä–¥—Ü–µ –≤—Å–µ–≥–¥–∞ –æ—Å—Ç–∞–≤–∞–ª–æ—Å—å –Ω–µ–∂–Ω—ã–º –∏ —Å–≤–µ—Ç–ª—ã–º. ‚ú® –ö–∞–∫ —Ç–æ–ª—å–∫–æ –ë–∞–±–∞—á–µ–Ω—É—à–∫—É –æ–ø—É—Å—Ç–∏–ª–∏ –≤ –≤–æ–ª—à–µ–±–Ω—É—é –≤–∞–Ω–Ω–æ—á–∫—É, –≤–æ–¥–∞ –∑–∞–∏—Å–∫—Ä–∏–ª–∞—Å—å, –∞ –∞—Ä–æ–º–∞—Ç —Ç—Ä–∞–≤ –Ω–∞–ø–æ–ª–Ω–∏–ª –≤—Å—é –Ω–æ—Ä–∫—É. –ú–∞–ª–µ–Ω—å–∫–∞—è –ë–∞–±–∞—á–µ–Ω—É—à–∫–∞ –∑–∞—É–ª—ã–±–∞–ª–∞—Å—å, –∏ —Ç—É—Ç –∂–µ –ª–µ—Å –Ω–∞–ø–æ–ª–Ω–∏–ª—Å—è —Ç–µ–ø–ª–æ–º, –∞ —Ü–≤–µ—Ç—ã —Ä–∞—Å–ø—É—Å—Ç–∏–ª–∏—Å—å! üå∏ üìÜ –®–ª–∏ –≥–æ–¥—ã, –ë–∞–±–∞—á–µ–Ω—É—à–∫–∞ —Ä–æ—Å–ª–∞, –∏ –≤—Å–µ –∑–∞–º–µ—á–∞–ª–∏, –∫–∞–∫–æ–π —á—É–¥–µ—Å–Ω–æ–π –æ–Ω–∞ —Å—Ç–∞–Ω–æ–≤–∏–ª–∞—Å—å. –û–Ω–∞ —É–º–µ–ª–∞ —Å–ª—É—à–∞—Ç—å –∏ —É—Ç–µ—à–∞—Ç—å, –∑–Ω–∞–ª–∞ –≤—Å–µ —Ç–∞–π–Ω—ã–µ —Ç—Ä–æ–ø–∏–Ω–∫–∏ –ª–µ—Å–∞ üåø, –∞ –µ—ë —Å–º–µ—Ö –¥–µ–ª–∞–ª –¥–∞–∂–µ —Ö–º—É—Ä—ã–µ –¥–Ω–∏ —Å–æ–ª–Ω–µ—á–Ω—ã–º–∏. üè° –û–¥–Ω–∞–∂–¥—ã —Å–ª—É—á–∏–ª–∞—Å—å –±–µ–¥–∞: –∑–ª–æ–π –≤–µ—Ç–µ—Ä —É–Ω–µ—Å —É —ë–∂–∏–∫–∞ –ö–æ–ª—é—á–∫–∏ –µ–≥–æ –¥–æ–º–∏–∫ –∏–∑ –ª–∏—Å—Ç—å–µ–≤ üçÇ. –ë–∞–±–∞—á–µ–Ω—É—à–∫–∞, –Ω–µ —Ä–∞–∑–¥—É–º—ã–≤–∞—è, —Å–æ–±—Ä–∞–ª–∞ –≤—Å–µ—Ö –ª–µ—Å–Ω—ã—Ö –¥—Ä—É–∑–µ–π üêªüê≠ü¶î, –∏ –¥—Ä—É–∂–Ω–æ–π –∫–æ–º–ø–∞–Ω–∏–µ–π –æ–Ω–∏ –ø–æ—Å—Ç—Ä–æ–∏–ª–∏ –µ–∂–∏–∫—É –Ω–æ–≤—ã–π –¥–æ–º ‚Äî –µ—â—ë –∫—Ä–µ–ø—á–µ –∏ —É—é—Ç–Ω–µ–µ. –° —Ç–µ—Ö –ø–æ—Ä –ë–∞–±–∞—á–µ–Ω—É—à–∫—É —Å—Ç–∞–ª–∏ –∑–≤–∞—Ç—å –õ–µ—Å–Ω—ã–º –°–æ–ª–Ω—ã—à–∫–æ–º ‚òÄÔ∏è, –ø–æ—Ç–æ–º—É —á—Ç–æ –æ–Ω–∞ —Å–æ–≥—Ä–µ–≤–∞–ª–∞ –≤—Å–µ—Ö –≤–æ–∫—Ä—É–≥. ‚è≥ –ì–æ–¥—ã —à–ª–∏, –∏ –ë–∞–±–∞—á–µ–Ω—É—à–∫–∞ —Ä–æ—Å–ª–∞. –û–Ω–∞ —Å—Ç–∞–ª–∞ –≥—Ä–∞—Ü–∏–æ–∑–Ω–æ–π, –º—É–¥—Ä–æ–π –∏ –µ—â—ë –±–æ–ª–µ–µ –¥–æ–±—Ä–æ–π –±–∞–±–∞—á–µ–Ω–∫–æ–π. –í—Å—è–∫–∏–π, –∫—Ç–æ –≤—Å—Ç—Ä–µ—á–∞–ª –µ—ë, —É–ª—ã–±–∞–ª—Å—è, –ø–æ—Ç–æ–º—É —á—Ç–æ –æ—Ç –Ω–µ—ë –∏—Å—Ö–æ–¥–∏–ª–æ –æ—Å–æ–±–æ–µ —Ç–µ–ø–ª–æ. üö∂‚Äç‚ôÄÔ∏è –ù–æ –≤–æ—Ç –Ω–∞—Å—Ç–∞–ª –¥–µ–Ω—å, –∫–æ–≥–¥–∞ –ë–∞–±–∞—á–µ–Ω—É—à–∫–µ –Ω—É–∂–Ω–æ –±—ã–ª–æ –ø–æ–∫–∏–Ω—É—Ç—å —Ä–æ–¥–Ω—É—é –Ω–æ—Ä–∫—É. –°–µ—Ä–¥—Ü–µ –ø–æ–¥—Å–∫–∞–∑—ã–≤–∞–ª–æ –µ–π, —á—Ç–æ –≤ –±–æ–ª—å—à–æ–º –º–∏—Ä–µ –µ—Å—Ç—å —Ç–µ, –∫—Ç–æ –Ω—É–∂–¥–∞–µ—Ç—Å—è –≤ –µ—ë –ø–æ–º–æ—â–∏. ‚Äî –ú—ã –≤—Å–µ–≥–¥–∞ –±—É–¥–µ–º –∂–¥–∞—Ç—å —Ç–µ–±—è, –º–∏–ª–∞—è! ‚Äî –∫—Ä–∏—á–∞–ª–∏ –µ–π –∑–≤–µ—Ä—É—à–∫–∏, –ø–æ–¥–∞–≤–∞—è —É–∑–µ–ª–æ–∫ —Å –æ—Ä–µ—à–∫–∞–º–∏ –∏ —Å—É—à–µ–Ω—ã–º–∏ —è–≥–æ–¥–∞–º–∏. üå∞üçá üí´ –ë–∞–±–∞—á–µ–Ω—É—à–∫–∞ –ø—Ä–æ—Å—Ç–∏–ª–∞—Å—å —Å —Å–µ–º—å—ë–π –∏ –¥—Ä—É–∑—å—è–º–∏ –∏ –æ—Ç–ø—Ä–∞–≤–∏–ª–∞—Å—å –≤ –ø—É—Ç—å. üèû –° —Ç–µ—Ö –ø–æ—Ä –≤ –ª–µ—Å—É –æ –Ω–µ–π —Ö–æ–¥–∏–ª–∏ –ª–µ–≥–µ–Ω–¥—ã. –õ–µ—Å–Ω—ã–µ –∑–≤–µ—Ä–∏ –ø–µ—Ä–µ–¥–∞–≤–∞–ª–∏ –¥—Ä—É–≥ –¥—Ä—É–≥—É –≤–µ—Å—Ç–∏ –æ –µ—ë –≤–µ–ª–∏–∫–∏—Ö –¥–æ–±—Ä—ã—Ö –¥–µ–ª–∞—Ö: üß∏ ‚Äú–ì–æ–≤–æ—Ä—è—Ç, —á—Ç–æ –ë–∞–±–∞—á–µ–Ω—É—à–∫–∞ –ø–æ–º–æ–≥–ª–∞ –º–∞–ª–µ–Ω—å–∫–æ–º—É –º–µ–¥–≤–µ–∂–æ–Ω–∫—É –Ω–∞–π—Ç–∏ –¥–æ—Ä–æ–≥—É –¥–æ–º–æ–π, –∫–æ–≥–¥–∞ –æ–Ω –∑–∞–±–ª—É–¥–∏–ª—Å—è –≤ –≥–æ—Ä–∞—Ö!‚Äù üêá ‚Äú–ê —è —Å–ª—ã—à–∞–ª–∞, —á—Ç–æ –æ–Ω–∞ –Ω–∞—É—á–∏–ª–∞ –ø—É–≥–ª–∏–≤–æ–≥–æ –∑–∞–π—á–æ–Ω–∫–∞ –±—ã—Ç—å —Å–º–µ–ª—ã–º –∏ –æ—Ç–≤–∞–∂–Ω—ã–º!‚Äù üí¶ ‚Äú–ê –µ—â—ë –æ–Ω–∞ —Å–ø–∞—Å–ª–∞ –ø—Ä—É–¥ –æ—Ç –∑–∞—Å—É—Ö–∏, —Ä–∞–∑—ã—Å–∫–∞–≤ –≤–æ–ª—à–µ–±–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫ –≤–æ–¥—ã!‚Äù ü¶â –í—Å—è–∫–∏–π —Ä–∞–∑, –∫–æ–≥–¥–∞ –≤ –ª–µ—Å—É –∫—Ç–æ-—Ç–æ –ø–æ–ø–∞–¥–∞–ª –≤ –±–µ–¥—É, —Å—Ç–∞—Ä—ã–π —Ñ–∏–ª–∏–Ω –ö–Ω–∏–≥–æ–≤–µ–¥ –≥–æ–≤–æ—Ä–∏–ª: ‚Äî –ù–µ –ø–µ—á–∞–ª—å—Ç–µ—Å—å, –¥—Ä—É–∑—å—è. –ì–¥–µ –±—ã –Ω–∏ –±—ã–ª–∞ –ë–∞–±–∞—á–µ–Ω—É—à–∫–∞, –æ–Ω–∞ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –Ω–∞–π–¥—ë—Ç —Å–ø–æ—Å–æ–± –ø–æ–º–æ—á—å. –î–æ–±—Ä–æ, –∫–æ—Ç–æ—Ä–æ–µ –º—ã –¥–∞—Ä–∏–º –º–∏—Ä—É, –≤—Å–µ–≥–¥–∞ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è! üåÖ –ò –∫–∞–∂–¥—ã–π –≤–µ—á–µ—Ä, –∫–æ–≥–¥–∞ —Å–æ–ª–Ω—Ü–µ —Å–∞–¥–∏–ª–æ—Å—å –∑–∞ —Ö–æ–ª–º—ã, –µ–≥–æ –º—è–≥–∫–∏–µ –ª—É—á–∏ –ª–æ–∂–∏–ª–∏—Å—å –Ω–∞ –ª–µ—Å —Ç–∞–∫ –±–µ—Ä–µ–∂–Ω–æ, –±—É–¥—Ç–æ —Å–∞–º–∞ –ë–∞–±–∞—á–µ–Ω—É—à–∫–∞ –ø—Ä–∏—Å—ã–ª–∞–ª–∞ —Å–≤–æ–π —Ç—ë–ø–ª—ã–π –ø—Ä–∏–≤–µ—Ç —Ä–æ–¥–Ω–æ–º—É –¥–æ–º—É. üêø –Ø –≤—ã—Ä–æ—Å –Ω–∞ —Ä–∞—Å—Å–∫–∞–∑–∞—Ö –æ —Ç–µ–±–µ, ‚Äî –≤–¥—Ä—É–≥ —Å–∫–∞–∑–∞–ª –º–∞–ª–µ–Ω—å–∫–∏–π –±–∞–±–∞—á–æ–∫ –®—É—Å—Ç—Ä–∏–∫, —Å—Ç–æ—è –ø–µ—Ä–µ–¥ –ë–∞–±–∞—á–µ–Ω—É—à–∫–æ–π. ‚Äî –í—Å–µ –≤ –Ω–∞—à–µ–º –ª–µ—Å—É –ø–æ–º–Ω—è—Ç –õ–µ—Å–Ω–æ–µ –°–æ–ª–Ω—ã—à–∫–æ, —á—Ç–æ —É—à–ª–æ –≤ –¥–∞–ª—å–Ω–∏–µ –∫—Ä–∞—è, —á—Ç–æ–±—ã –Ω–µ—Å—Ç–∏ –¥–æ–±—Ä–æ. –ö–∞–∂–¥—ã–π –≤–µ—á–µ—Ä, –∫–æ–≥–¥–∞ —Å–æ–ª–Ω—Ü–µ —Å–∞–¥–∏–ª–æ—Å—å –∑–∞ —Ö–æ–ª–º—ã, –µ–≥–æ –º—è–≥–∫–∏–µ –ª—É—á–∏ –ª–æ–∂–∏–ª–∏—Å—å –Ω–∞ –Ω–∞—à –ª–µ—Å, –∏ –≤—Å–µ –≤–µ—Ä–∏–ª–∏ ‚Äî —Ç—ã –æ –Ω–∞—Å –ø–æ–º–Ω–∏—à—å. –ù–æ –º–Ω–µ –±—ã–ª–æ –º–∞–ª–æ –æ–¥–Ω–∏—Ö —Ä–∞—Å—Å–∫–∞–∑–æ–≤ –∏ —Å–æ–ª–Ω–µ—á–Ω—ã—Ö –ª—É—á–µ–π. –Ø —Ö–æ—Ç–µ–ª –Ω–∞–π—Ç–∏ —Ç–µ–±—è. –•–æ—Ç–µ–ª —É–≤–∏–¥–µ—Ç—å —Å–≤–æ–∏–º–∏ –≥–ª–∞–∑–∞–º–∏ —Ç—É, –æ –∫–æ–º –≥–æ–≤–æ—Ä—è—Ç —Å —Ç–∞–∫–∏–º –≤–æ—Å—Ö–∏—â–µ–Ω–∏–µ–º. –Ø –ø–µ—Ä–µ—Å–µ–∫ —á–∞—â–∏ üå≤, –±—Ä–æ–¥–∏–ª –ø–æ —Ç—É–º–∞–Ω–Ω—ã–º –ª—É–≥–∞–º üåæ, –ø—Ä–æ–±–∏—Ä–∞–ª—Å—è —á–µ—Ä–µ–∑ –Ω–µ–∑–Ω–∞–∫–æ–º—ã–µ –ª–µ—Å–∞, –ø–æ–¥–Ω–∏–º–∞–ª—Å—è –≤ –≥–æ—Ä—ã üèî, –≥–¥–µ —Å–Ω–µ–≥ –±–µ–ª–µ–µ –º–æ–ª–æ–∫–∞. –Ø —Å–ø—Ä–∞—à–∏–≤–∞–ª —É —Å–æ–≤, —É –±—ã—Å—Ç—Ä—ã—Ö —Ä—É—á—å–µ–≤, —É –∑–≤–µ–∑–¥ ‚ú®‚Äî –∏ –≤—Å–µ –≥–æ–≤–æ—Ä–∏–ª–∏ –æ–¥–Ω–æ: ‚Äú–ë–∞–±–∞—á–µ–Ω—É—à–∫—É —Ç–∞–º, –≥–¥–µ –¥–æ–±—Ä–æ –∏ —Å–≤–µ—Ç.‚Äù ‚Äî –ò –≤–æ—Ç —è –∑–¥–µ—Å—å. –Ø –Ω–∞—à—ë–ª —Ç–µ–±—è. –ò —Å—á–∞—Å—Ç–ª–∏–≤. üíñ";

                    // –í—ã–±–∏—Ä–∞–µ–º —Å–ª—É—á–∞–π–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏–∑ –º–∞—Å—Å–∏–≤–∞ images
                    const image = images[Math.floor(Math.random() * images.length)];

                    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ñ–æ—Ç–æ
                    await bot.telegram.sendPhoto(task.chatId, image);

                    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –¥–ª–∏–Ω–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ —á–∞—Å—Ç—è–º
                    async function sendLongMessage(chatId, message) {
                        const maxLength = 4096; // –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –¥–ª–∏–Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è Telegram
                        // –†–∞–∑–±–∏–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –Ω–∞ —á–∞—Å—Ç–∏, –µ—Å–ª–∏ –æ–Ω–æ —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω–æ–µ
                        for (let i = 0; i < message.length; i += maxLength) {
                            const part = message.slice(i, i + maxLength);
                            await bot.telegram.sendMessage(chatId, part);
                        }
                    }

                    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–ª–∏–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ —á–∞—Å—Ç—è–º
                    await sendLongMessage(task.chatId, currentMessage);

                    // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω–¥–µ–∫—Å —Å–æ–æ–±—â–µ–Ω–∏—è
                    task.messageIndex = (task.messageIndex + 1) % messages.length;
                    await task.save();
                },
                null, // –ù–µ—Ç –æ–±—Ä–∞—Ç–Ω–æ–≥–æ –≤—ã–∑–æ–≤–∞ –¥–ª—è –æ—à–∏–±–æ–∫
                true, // –ó–∞–ø—É—Å–∫–∞–µ–º –∑–∞–¥–∞—á—É —Å—Ä–∞–∑—É
                "America/Anchorage" // –í—Ä–µ–º–µ–Ω–Ω–∞—è –∑–æ–Ω–∞
            );

            task.job = newJob;
            await task.save();
        }
    });
}




mongoose
    .connect(process.env.DB_HOST)
    .then(() => {
        console.log("Connected to database!");

        updateCronJobs();
    })
    .catch((err) => {
        console.error("Error connecting to the database:", err);
    });

const bot = new Telegraf(process.env.BOT_TOKEN);
const app = express();

app.use(express.json());

let task;

async function startCronJob(chatId) {
    let existingTask = await CronTask.findOne({ chatId });


    if (!existingTask) {
        existingTask = new CronTask({ chatId, messageIndex: 0 });
        await existingTask.save();
    }


    if (task) {
        task.stop();
        task = null;
    }


    task = new CronJob(
        "30 5 * * *",
        async function () {

            existingTask = await CronTask.findOne({ chatId });

            if (!existingTask) return;

            const currentMessage = messages[existingTask.messageIndex];
            const image = images[Math.floor(Math.random() * images.length)];

            await bot.telegram.sendPhoto(chatId, image);
            await bot.telegram.sendMessage(chatId, currentMessage);

            existingTask.messageIndex = (existingTask.messageIndex + 1) % messages.length;

            if (existingTask) {
                await existingTask.save();
            }
        },
        null,
        true,
        "America/Anchorage"
    );
}

bot.start((ctx) => {
    ctx.reply("üëã –ü—Ä–∏–≤–µ—Ç! –ú–µ–Ω—è –∑–æ–≤—É—Ç –ë–∞–±–∞—á–µ–Ω–æ–∫, —è —É–∑–Ω–∞–ª —á—Ç–æ —Ç—ã –∏–∑ —Å–µ–º—å–∏ –ë–∞–±–∞–∫–µ–≤–µ—á–µ–π –∏ —Ç—É—Ç –∂–µ –ø–æ—Å—Ç–∞—Ä–∞–ª—Å—è —Ç–µ–±—è –Ω–∞–π—Ç–∏ —á—Ç–æ–± —Å—Ç–∞—Ç—å —Ç–≤–æ–∏ –¥—Ä—É–≥–æ–º. –í –æ—Å–Ω–æ–≤–Ω–æ–º —è —Å–ø–ª—é –∫–∞–∫ –∏ –≤—Å–µ –º—ã –±–∞–±–∞–∫–∏, –Ω–æ —Å —ç—Ç–æ–≥–æ –¥–Ω—è —è —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ –±—É–¥—É –ø—Ä–æ—Å—ã–ø–∞—Ç—å—Å—è –∫–∞–∂–¥–æ–µ —É—Ç—Ä–æ —á—Ç–æ–± —Ç–≤–æ–µ —É—Ç—Ä–æ –±—ã–ª–æ –∫–∞–∫ –º–æ–∂–Ω–æ —Ç–µ–ø–ª–µ–µ –∏ —Ä–∞–¥–æ—Å—Ç–Ω–µ–µ! üåû\n ‚ú® –ï—Å–ª–∏ —Ö–æ—á–µ—à—å –¥—Ä—É–∂–∏—Ç—å —Å–æ –º–Ω–æ–π –ø—Ä–æ—Å—Ç–æ –Ω–∞–ø–∏—à–∏ '–î–∞–≤–∞–π –¥—Ä—É–∂–∏—Ç—å'\n –° —É–≤–∞–∂–µ–Ω–∏–µ–º, –ë–∞–±–∞—á–µ–Ω–æ–∫! üêø");
});

app.post(`/webhook/${process.env.BOT_TOKEN}`, (req, res) => {
    bot.handleUpdate(req.body);
    res.sendStatus(200);
});

bot.on("text", async (ctx) => {
    const message = ctx.message.text.toLowerCase();
    const chatId = ctx.chat.id;

    if (message === "–¥–∞–≤–∞–π –¥—Ä—É–∂–∏—Ç—å") {
        ctx.reply("üêø –£—Ä–∞!! –ú—ã —Å —Ç–æ–±–æ–π –¥—Ä—É–∑—å—è! –Ø —Ç–∞–∫ —Ä–∞–¥, —á—Ç–æ —Ç—ã —Ö–æ—á–µ—à—å –¥—Ä—É–∂–∏—Ç—å! –Ø –æ–±–µ—â–∞—é –¥–µ–ª–∞—Ç—å —Ç–≤–æ–∏ —É—Ç—Ä–µ–Ω–Ω–∏–µ —á–∞—Å—ã —è—Ä—á–µ –∏ –≤–µ—Å–µ–ª–µ–µ. –ö–∞–∂–¥–æ–µ —É—Ç—Ä–æ –±—É–¥—É –ø—Ä–æ—Å—ã–ø–∞—Ç—å—Å—è —Ç–æ–ª—å–∫–æ –¥–ª—è —Ç–æ–≥–æ, —á—Ç–æ–±—ã –ø–æ—Å–ª–∞—Ç—å —Ç–µ–±–µ –Ω–µ–º–Ω–æ–≥–æ –ø–æ–∑–∏—Ç–∏–≤–∞! üåû –¢–∞–∫ —á—Ç–æ –≥–æ—Ç–æ–≤—å—Å—è, —è –≤—Å–µ–≥–¥–∞ —Ä—è–¥–æ–º, –≥–æ—Ç–æ–≤ –ø–æ–¥–µ–ª–∏—Ç—å—Å—è –¥–æ–±—Ä—ã–º–∏ —Å–ª–æ–≤–∞–º–∏ –∏ —Ä–∞–¥–æ—Å—Ç—å—é! ‚ú®");

        const existingUser = await User.findOne({ chatId });
        if (!existingUser) {
            await new User({ chatId }).save();
        }

        startCronJob(chatId);

    } else if (message === "—è —Å–æ—Å–∫—É—á–∏–ª—Å—è") {
        ctx.reply("üêø –£—Ä–∞!!!! –¢—ã –≤–µ—Ä–Ω—É–ª—Å—è! –Ø —Ç–∞–∫ —Å–æ—Å–∫—É—á–∏–ª—Å—è –ø–æ —Ç–µ–±–µ! –¢–µ–ø–µ—Ä—å —è —Å–Ω–æ–≤–∞ –≥–æ—Ç–æ–≤ —Ä–∞–¥–æ–≤–∞—Ç—å —Ç–µ–±—è, –ø–æ–¥–Ω–∏–º–∞—Ç—å –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ –∏ –±—ã—Ç—å —Ä—è–¥–æ–º! –î–∞–≤–∞–π –Ω–∞—á–Ω–µ–º –Ω–æ–≤—ã–π –¥–µ–Ω—å —Å —É–ª—ã–±–∫–æ–π! üåû");

        startCronJob(chatId);

    } else if (message === "–Ω–µ —Ö–æ—á—É —Å —Ç–æ–±–æ–π –¥—Ä—É–∂–∏—Ç—å") {
        const existingTask = await CronTask.findOne({ chatId });
        if (existingTask) {
            await CronTask.deleteOne({ chatId });
            if (task) {
                task.stop();
                task = null;
            }
            ctx.reply(stopMsgs[Math.floor(Math.random() * stopMsgs.length)]);

        } else {
            ctx.reply("–Ø –∏ —Ç–∞–∫ –º–æ–ª—á–∞–ª... üòÖ");
        }
    } else {
        const randomExcuse = excuses[Math.floor(Math.random() * excuses.length)];
        bot.telegram.sendMessage(chatId, randomExcuse);
    }
});

const WEBHOOK_URL = `${process.env.SERVER_URL}/webhook/${process.env.BOT_TOKEN}`;
bot.telegram.setWebhook(WEBHOOK_URL).then(() => {
    console.log(`‚úÖ Webhook —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω: ${WEBHOOK_URL}`);
});


app.get("/", function (req, res) {
    res.send("Hello")
})

const PORT = 7001;
app.listen(PORT, () => {
    console.log(`üöÄ –°–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω –Ω–∞ –ø–æ—Ä—Ç—É ${PORT}`);
});